C51 COMPILER V8.18   BJDJ1602                                                              12/15/2009 19:50:09 PAGE 1   


C51 COMPILER V8.18, COMPILATION OF MODULE BJDJ1602
OBJECT MODULE PLACED IN BJDJ1602.OBJ
COMPILER INVOKED BY: C:\Keil\C51\BIN\C51.EXE BJDJ1602.C BROWSE DEBUG OBJECTEXTEND

line level    source

   1          
   2              
   3          #include <reg51.h>       //51芯片管脚定义头文件
   4          #include <intrins.h>  //内部包含延时函数 _nop_();
   5          
   6          #define uchar unsigned char
   7          #define uint  unsigned int
   8          #define delayNOP(); {_nop_();_nop_();_nop_();_nop_();};
   9          
  10          
  11          uchar code FFW[8]={0xf1,0xf3,0xf2,0xf6,0xf4,0xfc,0xf8,0xf9};
  12          uchar code REV[8]={0xf9,0xf8,0xfc,0xf4,0xf6,0xf2,0xf3,0xf1};
  13          
  14          sbit  K1   = P3^2;       //运行与停止
  15          sbit  K2   = P3^3;       //设定圈数
  16          sbit  K3   = P3^4;       //方向转换
  17          sbit  K4   = P3^5;       //速率调整
  18          sbit  BEEP = P3^6;       //蜂鸣器
  19          
  20          sbit  LCD_RS = P2^0;             
  21          sbit  LCD_RW = P2^1;
  22          sbit  LCD_EN = P2^2;
  23          
  24          bit  on_off=0;            //运行与停止标志
  25          bit  direction=1;         //方向标志
  26          bit  rate_dr=1;           //速率标志
  27          bit  snum_dr=1;           //圈数标志
  28          
  29          uchar code  cdis1[ ] = {" STEPPING MOTOR "};
  30          uchar code  cdis2[ ] = {"CONTROL  PROCESS"};
  31          uchar code  cdis3[ ] = {"    STOP        "};
  32          uchar code  cdis4[ ] = {"NUM:    RATE:   "};
  33          uchar code  cdis5[ ] = {"  RUNNING       "};
  34          
  35          uchar   m,v=0,q=0;
  36          
  37          uint   number=0,number1=0; 
  38          uchar   snum=10,snum1=10;       //预设定圈数
  39          uchar   rate=2;               //预设定速率
  40          uchar   data_temp,data_temP1,data_temp2;   
  41          
  42          /********************************************************/
  43          /*                                                  
  44          /* 延时t毫秒 
  45          /* 11.0592MHz时钟，延时约1ms                                     
  46          /*                                                      
  47          /********************************************************/
  48          void delay(uint t)
  49          {                           
  50   1         uchar k;
  51   1         while(t--)
  52   1         {
  53   2           for(k=0; k<125; k++)
  54   2           { }
  55   2         }
C51 COMPILER V8.18   BJDJ1602                                                              12/15/2009 19:50:09 PAGE 2   

  56   1      }
  57          
  58          /********************************************************/
  59          void delayB(uchar x)    //x*0.14MS
  60           {
  61   1         uchar i;
  62   1         while(x--)
  63   1         {
  64   2           for (i=0; i<13; i++)
  65   2           { }
  66   2         }
  67   1       }
  68          
  69          /********************************************************/
  70          void beep()
  71           {
  72   1         uchar j;
  73   1         for (j=0;j<100;j++)
  74   1          { 
  75   2           delayB(4);
  76   2           BEEP=!BEEP;                 //BEEP取反
  77   2          } 
  78   1           BEEP=1;                    //关闭蜂鸣器
  79   1        delay(170);
  80   1       }
  81          
  82          /********************************************************/
  83          /*                                                                
  84          /*检查LCD忙状态                                                   
  85          /*lcd_busy为1时，忙，等待。为0时,闲，可写指令与数据。     
  86          /*                                                               
  87          /********************************************************/ 
  88          
  89          bit lcd_busy()
  90           {                          
  91   1          bit result;
  92   1          LCD_RS = 0;
  93   1          LCD_RW = 1;
  94   1          LCD_EN = 1;
  95   1          delayNOP();
  96   1          result = (bit)(P0&0x80);
  97   1          LCD_EN = 0;
  98   1          return(result); 
  99   1       }
 100          
 101          /********************************************************/
 102          /*                                                                 
 103          /*写指令数据到LCD                                                 
 104          /*RS=L，RW=L，E=高脉冲，D0-D7=指令码。                             
 105          /*                                                               
 106          /********************************************************/
 107          
 108          void lcd_wcmd(uchar cmd)
 109          
 110          {                          
 111   1         while(lcd_busy());
 112   1          LCD_RS = 0;
 113   1          LCD_RW = 0;
 114   1          LCD_EN = 0;
 115   1          _nop_();
 116   1          _nop_(); 
 117   1          P0 = cmd;
C51 COMPILER V8.18   BJDJ1602                                                              12/15/2009 19:50:09 PAGE 3   

 118   1          delayNOP();
 119   1          LCD_EN = 1;
 120   1          delayNOP();
 121   1          LCD_EN = 0;  
 122   1      }
 123          
 124          /********************************************************/
 125          /*                                                                
 126          /*写显示数据到LCD                                                  
 127          /*RS=H，RW=L，E=高脉冲，D0-D7=数据。                              
 128          /*                                                               
 129          /********************************************************/
 130          
 131          void lcd_wdat(uchar dat)
 132          {                          
 133   1         while(lcd_busy());
 134   1          LCD_RS = 1;
 135   1          LCD_RW = 0;
 136   1          LCD_EN = 0;
 137   1          P0 = dat;
 138   1          delayNOP();
 139   1          LCD_EN = 1;
 140   1          delayNOP();
 141   1          LCD_EN = 0; 
 142   1      }
 143          
 144          /********************************************************/
 145          /*                                                                
 146          /*  LCD初始化设定                                                
 147          /*                                                                
 148          /********************************************************/
 149          
 150          void lcd_init()
 151          { 
 152   1          delay(30);                   
 153   1          lcd_wcmd(0x38);      //16*2显示，5*7点阵，8位数据
 154   1          delay(5);
 155   1          lcd_wcmd(0x38);         
 156   1          delay(5);
 157   1          lcd_wcmd(0x38);         
 158   1          delay(5);
 159   1      
 160   1          lcd_wcmd(0x0c);      //显示开，关光标
 161   1          delay(5);
 162   1          lcd_wcmd(0x06);      //移动光标
 163   1          delay(5);
 164   1          lcd_wcmd(0x01);      //清除LCD的显示内容
 165   1          delay(5);
 166   1      }
 167          
 168          /********************************************************/
 169          /*                                                                 
 170          /*  设定显示位置                                                  
 171          /*                                                                
 172          /********************************************************/
 173          
 174          void lcd_pos(uchar pos)
 175          {                          
 176   1        lcd_wcmd(pos | 0x80);  //数据指针=80+地址变量
 177   1      }
 178          
 179          /********************************************************/
C51 COMPILER V8.18   BJDJ1602                                                              12/15/2009 19:50:09 PAGE 4   

 180          /*                                                       
 181          /* LCD1602初始显示子程序                                             
 182          /*                                                      
 183          /********************************************************/
 184          void  LCD_init_DIS()
 185          {            
 186   1           delay(10);                 //延时
 187   1           lcd_init();                //初始化LCD             
 188   1              
 189   1           lcd_pos(0);                //设置显示位置为第一行的第1个字符
 190   1           m = 0;
 191   1           while(cdis1[m] != '\0')
 192   1            {                         //显示字符
 193   2              lcd_wdat(cdis1[m]);
 194   2              m++;
 195   2            }
 196   1      
 197   1           lcd_pos(0x40);             //设置显示位置为第二行第1个字符
 198   1           m = 0;
 199   1           while(cdis2[m] != '\0')
 200   1            {
 201   2              lcd_wdat(cdis2[m]);      //显示字符
 202   2              m++;
 203   2            }
 204   1      
 205   1            delay(3000);               //延时        
 206   1              
 207   1            lcd_pos(0);                //设置显示位置为第一行的第1个字符
 208   1            m = 0;
 209   1            while(cdis3[m] != '\0')
 210   1              {                        //显示字符
 211   2                lcd_wdat(cdis3[m]);
 212   2                m++;
 213   2              }
 214   1      
 215   1            lcd_pos(0x40);             //设置显示位置为第二行第1个字符
 216   1            m = 0;
 217   1           while(cdis4[m] != '\0')
 218   1              {
 219   2                lcd_wdat(cdis4[m]);    //显示字符
 220   2                m++;
 221   2              }      
 222   1      
 223   1              for(m=0;m<2;m++)
 224   1                { 
 225   2             lcd_pos(0x0c+m);    //显示方向符号
 226   2                   lcd_wdat(0x3e);
 227   2          }
 228   1      
 229   1      }
 230          /********************************************************/
 231          /*
 232          /*数据转换子程序
 233          /*
 234          /********************************************************/
 235          void  data_conv() 
 236           {
 237   1           data_temP1=data_temp/10;       //高位
 238   1        if(data_temP1==0)
 239   1        {data_temP1=0x20;}             //高位为0不显示
 240   1           else 
 241   1        {data_temP1=data_temP1+0x30;}
C51 COMPILER V8.18   BJDJ1602                                                              12/15/2009 19:50:09 PAGE 5   

 242   1      
 243   1         data_temp2=data_temp%10;       //低位
 244   1           data_temp2=data_temp2+0x30;
 245   1       }
 246          
 247          /********************************************************/
 248          /*
 249          /*数据显示子程序
 250          /*
 251          /********************************************************/
 252          void  data_dis()
 253          {
 254   1          data_temp = snum;        //显示圈数
 255   1          data_conv();
 256   1             lcd_pos(0x44); 
 257   1             lcd_wdat(data_temP1);
 258   1             lcd_pos(0x45); 
 259   1             lcd_wdat(data_temp2);
 260   1          
 261   1          data_temp = rate;         //显示速率
 262   1          data_conv();
 263   1             lcd_pos(0x4d); 
 264   1             lcd_wdat(data_temP1);
 265   1             lcd_pos(0x4e); 
 266   1             lcd_wdat(data_temp2);
 267   1      }
 268          /********************************************************
 269          /*
 270          /* 显示运行方向符号
 271          /*
 272          /********************************************************/
 273          void  motor_DR()
 274            {
 275   1             if(direction==1)           //正转方向标志
 276   1              { for(m=0;m<2;m++)
 277   2                { 
 278   3            lcd_pos(0x0c+m);      //显示方向符号
 279   3                  lcd_wdat(0x3e);
 280   3           }
 281   2         }
 282   1              else
 283   1               { for(m=0;m<2;m++)       //反转方向标志
 284   2                 { 
 285   3                lcd_pos(0x0c+m);     //显示方向符号 
 286   3                   lcd_wdat(0x3c);
 287   3           }
 288   2         }
 289   1        }
 290          
 291          /********************************************************
 292          /*
 293          /* 显示运行状态
 294          /*
 295          /********************************************************/
 296          void  motor_RUN()
 297           {
 298   1            if(on_off==1)
 299   1          { TR0=1; 
 300   2            lcd_pos(0);     //设置显示位置为第一行的第1个字符
 301   2               m = 0;
 302   2               while(cdis5[m] != '\0')
 303   2                { lcd_wdat(cdis5[m]);      //RUNNING
C51 COMPILER V8.18   BJDJ1602                                                              12/15/2009 19:50:09 PAGE 6   

 304   3                  m++;   }
 305   2                  motor_DR();              //
 306   2          }  
 307   1            else  
 308   1          { TR0=0; P1 =0x0f; 
 309   2         lcd_pos(0);     //设置显示位置为第一行的第1个字符
 310   2               m = 0;
 311   2               while(cdis3[m] != '\0')
 312   2                { lcd_wdat(cdis3[m]);      //STOP
 313   3                  m++;   }
 314   2                  motor_DR();              //
 315   2         snum=snum1;             //
 316   2         number1=0;              //清圈数计数器
 317   2               }
 318   1        }
 319          
 320          /********************************************************
 321          *                                                       
 322          *  主程序                                               
 323          *                                                      
 324          *********************************************************/
 325          
 326          main()
 327           { 
 328   1               LCD_init_DIS();
 329   1        
 330   1         TMOD = 0x01;       //T0定时方式1
 331   1         TL0  = 0x33;
 332   1         TH0  = 0xf5;
 333   1         EA   = 1;
 334   1         ET0  = 1; 
 335   1          P1   = 0x0f;
 336   1        
 337   1         while(1)
 338   1          {  
 339   2             if(K1==0)
 340   2          {
 341   3               beep();
 342   3            while(K1==0);       //等待键释放
 343   3            on_off=~on_off;       
 344   3               motor_RUN();  
 345   3              }   //K1 end
 346   2      /********************************************************/
 347   2            if(K2==0)    
 348   2             {
 349   3            beep();
 350   3         if(snum_dr==1)
 351   3          { snum++;
 352   4              snum1=snum;
 353   4            if(snum==0x14)
 354   4                  { snum_dr=~snum_dr;}
 355   4          }
 356   3         else  
 357   3           {snum--;
 358   4         snum1=snum;
 359   4            if(snum==0x01)
 360   4         { snum_dr=~snum_dr; }
 361   4           }
 362   3         
 363   3          } //K2  end
 364   2      /********************************************************/
 365   2              if(K3==0)    
C51 COMPILER V8.18   BJDJ1602                                                              12/15/2009 19:50:09 PAGE 7   

 366   2            {
 367   3            beep();
 368   3         direction=~direction; 
 369   3               motor_DR();
 370   3            }//K3 end
 371   2      
 372   2      /********************************************************/
 373   2              if(K4==0)    
 374   2             {
 375   3            beep();
 376   3         if(rate_dr==1)
 377   3          { rate++;
 378   4            if(rate==0x10)
 379   4                  { rate_dr=~rate_dr;}
 380   4          }
 381   3          else  
 382   3           { 
 383   4            rate--;
 384   4            if(rate==0x01)
 385   4         { rate_dr=~rate_dr; }
 386   4           }
 387   3        } //K4 end
 388   2          
 389   2      /********************************************************/
 390   2            if(number1==snum1)   //与设定圈数是否相等  
 391   2           { number1=0; 
 392   3               on_off=0;
 393   3               TR0=0;
 394   3              snum=snum1;
 395   3         P1=0x0f;
 396   3          motor_RUN();
 397   3          }         
 398   2               data_dis();
 399   2       }  // while(1) end
 400   1       }  //main end
 401          
 402          /********************************************************/
 403          /*
 404          /*  定时器 0 中断 
 405          /*
 406          /********************************************************/
 407          
 408          void  motor_onoff()  interrupt  1  
 409           {     
 410   1             TL0  = 0x33;
 411   1             TH0  = 0xf5; 
 412   1             q++;
 413   1          if(q < rate)
 414   1              { return; }
 415   1          else 
 416   1             {  q=0;    
 417   2             number++;                  //脉冲计数
 418   2              
 419   2            if(number==4096)              //64个脉冲电机转一圈
 420   2             { snum--;
 421   3            number=0;
 422   3                  number1++; }          //电机转动圈数
 423   2          
 424   2      
 425   2               if(direction==1)            //方向标志
 426   2             { if(v<8)  
 427   3               {P1 = FFW[v];v++;}       //取数据，正转
C51 COMPILER V8.18   BJDJ1602                                                              12/15/2009 19:50:09 PAGE 8   

 428   3              if(v==8) 
 429   3              { v=0; } 
 430   3                }
 431   2         
 432   2            else
 433   2             { if(v<8)  
 434   3               {P1 = REV[v];v++;}       //取数据，反转
 435   3               if(v==8) 
 436   3               { v=0; } 
 437   3                }
 438   2          }
 439   1       } 


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    811    ----
   CONSTANT SIZE    =    101    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     13    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =      4       1
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
