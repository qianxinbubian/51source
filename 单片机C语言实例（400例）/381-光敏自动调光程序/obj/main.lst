C51 COMPILER V8.02   MAIN                                                                  05/25/2013 14:48:48 PAGE 1   


C51 COMPILER V8.02, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN .\obj\main.obj
COMPILER INVOKED BY: C:\Keil\C51\BIN\C51.EXE main.c BROWSE DEBUG OBJECTEXTEND PRINT(.\obj\main.lst) OBJECT(.\obj\main.ob
                    -j)

line level    source

   1          /*-----------------------------------------------
   2            名称：IIC协议 PCF8591 AD/DA转换 测试光敏电阻
   3            论坛：www.doflye.net
   4            编写：shifang
   5            修改：无
   6            内容：使用4路AD中的1路检测外部模拟量输入，显示0-255数值
   7                  DA输出电压用LED显示，主要用于检测环境光线，光线强，则灯亮度小，以保证整体光强稳定在一个范围
   8                          这种思路和用法主要用于自动调光，可以根据环境亮度自动调节，从而达到节能最大化，本样例演示用
   9          ------------------------------------------------*/  
  10          #include <reg52.h>                
  11          #include "i2c.h"
  12          #include "delay.h"
  13          #include "display.h"
  14          
  15          #define AddWr 0x90   //写数据地址 
  16          #define AddRd 0x91   //读数据地址
  17          
  18          extern bit ack;
  19          unsigned char ReadADC(unsigned char Chl);
  20          bit WriteDAC(unsigned char dat);
  21          /*------------------------------------------------
  22                        主程序
  23          ------------------------------------------------*/
  24          main()
  25          {
  26   1       unsigned char num=0;
  27   1       Init_Timer0();
  28   1      
  29   1      
  30   1      while (1)         //主循环
  31   1        {
  32   2        
  33   2       num=ReadADC(2);//
  34   2       TempData[0]=DuanMa[num/100];    
  35   2       TempData[1]=DuanMa[(num%100)/10];
  36   2       TempData[2]=DuanMa[(num%100)%10];
  37   2       //主循环中添加其他需要一直工作的程序
  38   2       WriteDAC(num);//把当前值写入DA，用led演示亮度
  39   2       DelayMs(100);
  40   2        }
  41   1      }
  42          /*------------------------------------------------
  43                       读AD转值程序
  44          输入参数 Chl 表示需要转换的通道，范围从0-3
  45          返回值范围0-255
  46          ------------------------------------------------*/
  47          unsigned char ReadADC(unsigned char Chl)
  48           {
  49   1         unsigned char Val;
  50   1         Start_I2c();               //启动总线
  51   1         SendByte(AddWr);             //发送器件地址
  52   1           if(ack==0)return(0);
  53   1         SendByte(0x40|Chl);            //发送器件子地址
  54   1           if(ack==0)return(0);
C51 COMPILER V8.02   MAIN                                                                  05/25/2013 14:48:48 PAGE 2   

  55   1         Start_I2c();
  56   1         SendByte(AddWr+1);
  57   1            if(ack==0)return(0);
  58   1         Val=RcvByte();
  59   1         NoAck_I2c();                 //发送非应位
  60   1         Stop_I2c();                  //结束总线
  61   1        return(Val);
  62   1       }
  63          /*------------------------------------------------
  64                         写入DA转换数值
  65          输入参数：dat 表示需要转换的DA数值，范围是0-255
  66          ------------------------------------------------*/
  67          bit WriteDAC(unsigned char dat)
  68          {
  69   1         Start_I2c();               //启动总线
  70   1         SendByte(AddWr);             //发送器件地址
  71   1           if(ack==0)return(0);
  72   1         SendByte(0x40);            //发送器件子地址
  73   1           if(ack==0)return(0);
  74   1         SendByte(dat);             //发送数据
  75   1           if(ack==0)return(0);
  76   1         Stop_I2c();  
  77   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    160    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----       4
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
