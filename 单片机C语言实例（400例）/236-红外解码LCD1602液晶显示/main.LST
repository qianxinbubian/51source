C51 COMPILER V7.06   MAIN                                                                  05/13/2009 11:08:07 PAGE 1   


C51 COMPILER V7.06, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN main.OBJ
COMPILER INVOKED BY: d:\Keil\C51\BIN\C51.EXE main.c BROWSE DEBUG OBJECTEXTEND

stmt level    source

   1          /*-----------------------------------------------
   2            名称：遥控器红外解码液晶显示
   3            公司：上海浩豚电子科技有限公司
   4            编写：师访
   5            日期：2009.5
   6            修改：无
   7            内容：
   8          ------------------------------------------------*/
   9          #include<reg52.h>    //包含头文件，一般情况不需要改动，头文件包含特殊功能寄存器的定义
  10          #include<stdio.h>
  11          #include<intrins.h>
  12          
  13          
  14          #define TURE 1
  15          #define FALSE 0
  16          
  17          
  18          sbit IR=P3^2;  //红外接口标志
  19          sbit RS = P2^4;//Pin4
  20          sbit RW = P2^5;//Pin5
  21          sbit E  = P2^6;//Pin6
  22          
  23          #define Data P0//数据端口
  24          
  25          unsigned int hour,minute,second,count;
  26          char code Tab[16]="0123456789ABCDEF";
  27          
  28          char data TimeNum[]="                ";
  29          char data Test1[]="                  ";
  30          
  31          /******************************************************************/
  32          /*                    变量声明                                    */
  33          /******************************************************************/
  34          
  35          unsigned char  irtime;//红外用全局变量
  36          
  37          bit irpro_ok,irok;
  38          unsigned char   IRcord[4];  //处理后的红外码，分别是 客户码，客户码，数据码，数据码反码
  39          unsigned char   irdata[33]; //33个高低电平的时间数据
  40          
  41          /******************************************************************/
  42          /*                    函数声明                                    */
  43          /******************************************************************/
  44          void Ir_work(void);
  45          void Ircordpro(void);
  46          void ShowString (unsigned char line,char *ptr);
  47          /******************************************************************/
  48          /*                    定时器0中断服务函数                         */
  49          /******************************************************************/
  50          
  51          void tim0_isr (void) interrupt 1 using 1//定时器0中断服务函数
  52          {
  53   1        irtime++;                             //用于计数2个下降沿之间的时间
  54   1      }
  55          
C51 COMPILER V7.06   MAIN                                                                  05/13/2009 11:08:07 PAGE 2   

  56          /******************************************************************/
  57          /*                    外部中断0函数                               */
  58          /******************************************************************/
  59          void ex0_isr (void) interrupt 0 using 0//外部中断0服务函数
  60          {
  61   1        static unsigned char  i;             //接收红外信号处理
  62   1        static bit startflag;                //是否开始处理标志位
  63   1      
  64   1       if(startflag)                         
  65   1       {
  66   2         
  67   2          if(irtime<63&&irtime>=33)//引导码 TC9012的头码，9ms+4.5ms
  68   2                  i=0;
  69   2           
  70   2                      irdata[i]=irtime;//存储每个电平的持续时间，用于以后判断是0还是1
  71   2                      irtime=0;
  72   2                      i++;
  73   2                               if(i==33)
  74   2                              {
  75   3                                       irok=1;
  76   3                                       i=0;
  77   3                                      }
  78   2                }
  79   1               
  80   1               else
  81   1                      {irtime=0;startflag=1;}
  82   1      
  83   1      }
  84          
  85          /******************************************************************/
  86          /*                   定时器0初始化                                */
  87          /******************************************************************/
  88          void TIM0init(void)//定时器0初始化
  89          {
  90   1      
  91   1        TMOD=0x02;//定时器0工作方式2，TH0是重装值，TL0是初值
  92   1        TH0=0x00; //重载值
  93   1        TL0=0x00; //初始化值
  94   1        ET0=1;    //开中断
  95   1        TR0=1;    
  96   1      }
  97          /******************************************************************/
  98          /*                   外部中断初始化                               */
  99          /******************************************************************/
 100          void EX0init(void)
 101          {
 102   1       IT0 = 1;   //指定外部中断0下降沿触发，INT0 (P3.2)
 103   1       EX0 = 1;   //使能外部中断
 104   1       EA = 1;    //开总中断
 105   1      }
 106          /******************************************************************/
 107          /*                    红外键值处理                                */
 108          /******************************************************************/
 109          
 110            void Ir_work(void)        //红外键值散转程序
 111            {
 112   1             
 113   1             TimeNum[5] = Tab[IRcord[0]/16];   //处理客户码并显示
 114   1                 TimeNum[6] = Tab[IRcord[0]%16];
 115   1                 TimeNum[8] = Tab[IRcord[1]/16];   //处理客户码并显示
 116   1                 TimeNum[9] = Tab[IRcord[1]%16];
 117   1                 TimeNum[11] = Tab[IRcord[2]/16];  //处理数据码并显示
C51 COMPILER V7.06   MAIN                                                                  05/13/2009 11:08:07 PAGE 3   

 118   1                 TimeNum[12] = Tab[IRcord[2]%16];
 119   1                 TimeNum[14] = Tab[IRcord[3]/16];  //处理数据反码并显示
 120   1                 TimeNum[15] = Tab[IRcord[3]%16];
 121   1               
 122   1             ShowString(1,TimeNum);//显示处理过后的码值
 123   1                 irpro_ok=0;           //处理完成后清楚标志位
 124   1      
 125   1        }
 126          
 127          /******************************************************************/
 128          /*                    红外解码函数处理                            */
 129          /******************************************************************/
 130          void Ircordpro(void)//红外码值处理函数
 131          { 
 132   1        unsigned char i, j, k;
 133   1        unsigned char cord,value;
 134   1      
 135   1        k=1;
 136   1        for(i=0;i<4;i++)      //处理4个字节
 137   1           {
 138   2            for(j=1;j<=8;j++) //处理1个字节8位
 139   2               {
 140   3                cord=irdata[k];
 141   3                if(cord>7)//大于某值为1，这个和晶振有绝对关系，这里使用12M计算，此值可以有一定误差
 142   3                          {
 143   4                   value=value|0x80;
 144   4                              }
 145   3                else 
 146   3                          {
 147   4                   value=value;
 148   4                              }
 149   3                if(j<8)
 150   3                          {
 151   4                               value=value>>1;
 152   4                              }
 153   3                 k++;
 154   3               }
 155   2           IRcord[i]=value;
 156   2           value=0;     
 157   2           } irpro_ok=1;//处理完毕标志位置1
 158   1          
 159   1      }
 160          
 161          
 162          /******************************************************************/
 163          /*                    微秒延时函数                                */
 164          /******************************************************************/
 165          void DelayUs(unsigned char us)//delay us
 166          {
 167   1       unsigned char uscnt;
 168   1       uscnt=us>>1;/* Crystal frequency in 12MHz*/
 169   1       while(--uscnt);
 170   1      }
 171          /******************************************************************/
 172          /*                    毫秒函数声明                                */
 173          /******************************************************************/
 174          void DelayMs(unsigned char ms)//delay Ms
 175          {
 176   1       while(--ms)
 177   1         {
 178   2           DelayUs(250);
 179   2           DelayUs(250);
C51 COMPILER V7.06   MAIN                                                                  05/13/2009 11:08:07 PAGE 4   

 180   2               DelayUs(250);
 181   2               DelayUs(250);
 182   2         }
 183   1      }
 184          
 185          /******************************************************************/
 186          /*                   写入命令函数                                 */
 187          /******************************************************************/
 188          void WriteCommand(unsigned char c)
 189          {
 190   1       DelayMs(5);//操作前短暂延时，保证信号稳定
 191   1       E=0;
 192   1       RS=0;
 193   1       RW=0;
 194   1       _nop_();
 195   1       E=1;
 196   1       Data=c;
 197   1       E=0;
 198   1      }
 199          /******************************************************************/
 200          /*                   写入数据函数                                 */
 201          /******************************************************************/
 202          void WriteData(unsigned char c)
 203          {
 204   1       DelayMs(5);  //操作前短暂延时，保证信号稳定
 205   1       E=0;
 206   1       RS=1;
 207   1       RW=0;
 208   1       _nop_();
 209   1       E=1;
 210   1       Data=c;
 211   1       E=0;
 212   1       RS=0;
 213   1      }
 214          /******************************************************************/
 215          /*                   写入字节函数                                 */
 216          /******************************************************************/
 217          void ShowChar(unsigned char pos,unsigned char c)
 218          {
 219   1       unsigned char p;
 220   1       if (pos>=0x10)
 221   1          p=pos+0xb0; //是第二行则命令代码高4位为0xc
 222   1       else 
 223   1          p=pos+0x80; //是第二行则命令代码高4位为0x8
 224   1       WriteCommand (p);//写命令
 225   1       WriteData (c);   //写数据
 226   1      }
 227          /******************************************************************/
 228          /*                   写入字符串函数                               */
 229          /******************************************************************/
 230          void ShowString (unsigned char line,char *ptr)
 231          {
 232   1       unsigned char l,i;
 233   1       l=line<<4;
 234   1       for (i=0;i<16;i++)
 235   1        ShowChar (l++,*(ptr+i));//循环显示16个字符
 236   1      }
 237          /******************************************************************/
 238          /*                   初始化函数                                   */
 239          /******************************************************************/
 240          void InitLcd()
 241          {
C51 COMPILER V7.06   MAIN                                                                  05/13/2009 11:08:07 PAGE 5   

 242   1       DelayMs(15);
 243   1       WriteCommand(0x38); //display mode
 244   1       WriteCommand(0x38); //display mode
 245   1       WriteCommand(0x38); //display mode
 246   1       WriteCommand(0x06); //显示光标移动位置
 247   1       WriteCommand(0x0c); //显示开及光标设置
 248   1       WriteCommand(0x01); //显示清屏
 249   1      
 250   1      }
 251          
 252          
 253          /******************************************************************/
 254          /*                   主函数                                       */
 255          /******************************************************************/
 256          
 257          void main(void)
 258          {
 259   1       EX0init(); //初始化外部中断
 260   1       TIM0init();//初始化定时器
 261   1      
 262   1       InitLcd();//初始化液晶
 263   1       DelayMs(15);
 264   1      
 265   1       sprintf(Test1," www.haotun.com "); //显示第一行固定信息
 266   1       ShowString(0,Test1);
 267   1      
 268   1       sprintf(TimeNum,"Code            ");//显示第二行固定信息
 269   1       ShowString(1,TimeNum);
 270   1      
 271   1      
 272   1       while(1)//主循环
 273   1         {
 274   2          if(irok)                        //如果接收好了进行红外处理
 275   2                {   
 276   3                 Ircordpro();
 277   3                 irok=0;
 278   3                }
 279   2      
 280   2          if(irpro_ok)                   //如果处理好后进行工作处理，如按对应的按键后显示对应的数字等
 281   2                {
 282   3                 Ir_work();
 283   3                }
 284   2         }
 285   1      }
 286            


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    477    ----
   CONSTANT SIZE    =     50    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     83       5
   IDATA SIZE       =   ----    ----
   BIT SIZE         =      3    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
