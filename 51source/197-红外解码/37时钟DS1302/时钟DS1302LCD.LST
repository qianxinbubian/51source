C51 COMPILER V7.02b   _钟DS1302LCD                                                        02/25/2010 14:59:24 PAGE 1   


C51 COMPILER V7.02b, COMPILATION OF MODULE _钟DS1302LCD
OBJECT MODULE PLACED IN 时钟DS1302LCD.OBJ
COMPILER INVOKED BY: D:\Progrom\Keil\C51\BIN\C51.EXE 时钟DS1302LCD.c BROWSE DEBUG OBJECTEXTEND

stmt level    source

   1          /********************************************************************
   2          * 文件名  ： 时钟DS1302.c
   3          * 描述    :  该文件实现用DS1302来实现日历和时钟功能，数码管上显示出来。
   4          * 创建人  ： 东流，2009年4月10日
   5          * 版本号  ： 2.0
   6          ***********************************************************************/
   7          #include<reg52.h>
   8          #include<intrins.h>
   9          
  10          #define uchar unsigned char
  11          #define uint  unsigned int
  12          
  13          uchar code table[10] = {0x3f,0x06,0x5b,0x4f,0x66,0x6d,0x7d,0x07,0x7f,0x6f};
  14          sbit ACC0 = ACC^0;
  15          sbit ACC7 = ACC^7;
  16          sbit P3_2 = P3^2;
  17          sbit P3_5 = P3^4;
  18          
  19          sbit T_CLK = P1^6; /*实时时钟时钟线引脚 */
  20          sbit T_IO = P3^5; /*实时时钟数据线引脚 */
  21          sbit T_RST = P1^7; /*实时时钟复位线引脚 */
  22          
  23          /********************************************************************
  24          * 名称 : delay()
  25          * 功能 : 延时,延时时间大概为140US。
  26          * 输入 : 无
  27          * 输出 : 无
  28          ***********************************************************************/
  29          
  30          void delay()
  31          {
  32   1              int i,j;
  33   1              for(i=0; i<=10; i++)
  34   1              for(j=0; j<=2; j++)
  35   1      ;
  36   1      }
  37          
  38          /********************************************************************
  39          * 名称 : Delay_1ms()
  40          * 功能 : 延时子程序，延时时间为 1ms * x
  41          * 输入 : x (延时一毫秒的个数)
  42          * 输出 : 无
  43          ***********************************************************************/
  44          void Delay_1ms(uint i)//1ms延时
  45          {
  46   1              uchar x,j;
  47   1              for(j=0;j<i;j++)
  48   1              for(x=0;x<=148;x++);    
  49   1      }
  50          
  51          /********************************************************************
  52          * 名称 :  v_RTInputByte（）
  53          * 功能 :  往DS1302写入1Byte数据
  54          * 输入 :  ucDa 写入的数据
  55          * 输出 :  无
C51 COMPILER V7.02b   _钟DS1302LCD                                                        02/25/2010 14:59:24 PAGE 2   

  56          ***********************************************************************/
  57          void v_RTInputByte(uchar ucDa)
  58          {
  59   1              uchar i;
  60   1              ACC = ucDa;
  61   1              T_RST = 1;
  62   1              for(i=8; i>0; i--)
  63   1              {
  64   2                      T_IO = ACC0;
  65   2                      T_CLK = 1;
  66   2                      T_CLK = 0;
  67   2                      ACC = ACC >> 1;
  68   2              }
  69   1      }
  70          
  71          /********************************************************************
  72          * 名称  :   uc_RTOutputByte（）
  73          * 功能  :   从DS1302读取1Byte数据
  74          * 输入  :       无
  75          * 返回值:   ACC
  76          ***********************************************************************/
  77          uchar uc_RTOutputByte(void) 
  78          {
  79   1              uchar i;
  80   1              T_RST = 1;
  81   1              for(i=8; i>0; i--)
  82   1              {
  83   2                      ACC = ACC >>1;
  84   2                      T_IO=1;
  85   2                      ACC7 = T_IO;
  86   2                      T_CLK = 1;
  87   2                      T_CLK = 0;
  88   2              }
  89   1              return(ACC);
  90   1      }
  91          
  92          /********************************************************************
  93          * 名称   :   v_W1302(uchar ucAddr, uchar ucDa)
  94          * 功能   :   往DS1302写入数据
  95          * 输入   :   ucAddr: DS1302地址, ucDa: 要写的数据
  96          * 返回值 :   无
  97          ***********************************************************************/
  98          void v_W1302(uchar ucAddr, uchar ucDa)
  99          {
 100   1              T_RST = 0;
 101   1              T_CLK = 0;
 102   1              T_RST = 1;
 103   1              v_RTInputByte(ucAddr);   // 写地址 
 104   1              _nop_();
 105   1              _nop_();
 106   1              v_RTInputByte(ucDa);     // 写1Byte数据
 107   1              T_CLK = 1;
 108   1              T_RST = 0;
 109   1      }
 110          
 111          /********************************************************************
 112          * 名称   :  uc_R1302(uchar ucAddr)
 113          * 功能   :  读取DS1302某地址的数据
 114          * 输入   :  ucAddr: DS1302地址
 115          * 返回值 :  ucDa :读取的数据
 116          ***********************************************************************/
 117          uchar uc_R1302(uchar ucAddr)
C51 COMPILER V7.02b   _钟DS1302LCD                                                        02/25/2010 14:59:24 PAGE 3   

 118          {
 119   1              uchar ucDa;
 120   1              T_RST = 0;
 121   1              T_CLK = 0;
 122   1              T_RST = 1;
 123   1              v_RTInputByte(ucAddr);    //写地址，命令
 124   1              _nop_();
 125   1              _nop_();
 126   1              ucDa = uc_RTOutputByte(); //读1Byte数据
 127   1              T_CLK = 1;
 128   1              T_RST = 0;
 129   1              return(ucDa);
 130   1      }
 131          
 132          /********************************************************************
 133          * 名称   :  v_BurstW1302T
 134          * 功能   :  往DS1302写入时钟数据(多字节方式)
 135          * 输入   :  pSecDa: 时钟数据地址 格式为: 秒 分 时 日 月 星期 年 控制
 136          *                                                  8Byte (BCD码) 1B 1B 1B 1B 1B 1B  1B  1B
 137          * 返回值 :  无
 138          ***********************************************************************/
 139          void v_BurstW1302T(uchar *pSecDa)
 140          {
 141   1              uchar i;
 142   1              v_W1302(0x8e, 0x00);          //控制命令,WP=0,写操作
 143   1              T_RST = 0;
 144   1              T_CLK = 0;
 145   1              T_RST = 1;
 146   1              v_RTInputByte(0xbe);          //0xbe:时钟多字节写命令
 147   1              for(i=8; i>0; i--)            //8Byte = 7Byte 时钟数据 + 1Byte 控制
 148   1              {
 149   2                      v_RTInputByte(*pSecDa);   //写1Byte数据
 150   2                      pSecDa++;
 151   2              }
 152   1              T_CLK = 1;
 153   1              T_RST = 0;
 154   1      }
 155          
 156          /********************************************************************
 157          * 名称   :  v_BurstR1302T(uchar *pSecDa)
 158          * 功能   :  读取DS1302时钟数据
 159          * 输入   :  pSecDa: 时钟数据地址 格式为: 秒 分 时 日 月 星期 年
 160          *                                              7Byte (BCD码) 1B 1B 1B 1B 1B 1B   1B
 161          * 返回值 :  ucDa :读取的数据
 162          ***********************************************************************/
 163          void v_BurstR1302T(uchar *pSecDa)
 164          {
 165   1              uchar i;
 166   1              T_RST = 0;
 167   1              T_CLK = 0;
 168   1              T_RST = 1;
 169   1              v_RTInputByte(0xbf);               //0xbf:时钟多字节读命令
 170   1              for(i=8; i>0; i--)
 171   1              {
 172   2                      *pSecDa = uc_RTOutputByte();   //读1Byte数据
 173   2                      pSecDa++;
 174   2              }
 175   1              T_CLK = 1;
 176   1              T_RST = 0;
 177   1      }
 178          
 179          /********************************************************************
C51 COMPILER V7.02b   _钟DS1302LCD                                                        02/25/2010 14:59:24 PAGE 4   

 180          * 名称   :  v_BurstW1302R(uchar *pReDa)
 181          * 功能   :  往DS1302寄存器数写入数据(多字节方式)
 182          * 输入   :  pReDa: 寄存器数据地址
 183          * 返回值 :  无
 184          ***********************************************************************/
 185          void v_BurstW1302R(uchar *pReDa)
 186          {
 187   1              uchar i;
 188   1              v_W1302(0x8e,0x00);         //控制命令,WP=0,写操作
 189   1              T_RST = 0;
 190   1              T_CLK = 0;
 191   1              T_RST = 1;
 192   1              v_RTInputByte(0xfe);       //0xbe:时钟多字节写命令
 193   1              for(i=31; i>0; i--)        //31Byte 寄存器数据
 194   1              {
 195   2                      v_RTInputByte(*pReDa); //写1Byte数据
 196   2                      pReDa++;
 197   2              }
 198   1              T_CLK = 1;
 199   1              T_RST = 0;
 200   1      }
 201          
 202          /********************************************************************
 203          * 名称   :  v_BurstR1302R(uchar *pReDa)
 204          * 功能   :  读取DS1302寄存器数据
 205          * 输入   :  pReDa: 寄存器数据地址
 206          * 返回值 :  无
 207          ***********************************************************************/
 208          void v_BurstR1302R(uchar *pReDa)
 209          {
 210   1              uchar i;
 211   1              T_RST = 0;
 212   1              T_CLK = 0;
 213   1              T_RST = 1;
 214   1              v_RTInputByte(0xff);            //0xbf:时钟多字节读命令
 215   1              for(i=31; i>0; i--)             //31Byte 寄存器数据
 216   1              {
 217   2                      *pReDa = uc_RTOutputByte(); //读1Byte数据
 218   2                      pReDa++;
 219   2              }
 220   1              T_CLK = 1;
 221   1              T_RST = 0;
 222   1      }
 223          
 224          /********************************************************************
 225          * 名称  :  v_Set1302(uchar *pSecDa)
 226          * 功能  :  设置初始时间
 227          * 输入  :  pSecDa: 初始时间地址。初始时间格式为: 秒 分 时 日 月 星期 年
 228          *                                                                  7Byte (BCD码) 1B 1B 1B 1B 1B 1B  1B
 229          * 返回值: 无
 230          ***********************************************************************/
 231          void v_Set1302(uchar *pSecDa)
 232          {
 233   1              uchar i;
 234   1              uchar ucAddr = 0x80;
 235   1              v_W1302(0x8e, 0x00);            //控制命令,WP=0,写操作
 236   1              for(i=7; i>0; i--)
 237   1              {
 238   2                      v_W1302(ucAddr, *pSecDa);   // 秒 分 时 日 月 星期 年
 239   2                      pSecDa++;
 240   2                      ucAddr += 2;
 241   2              }
C51 COMPILER V7.02b   _钟DS1302LCD                                                        02/25/2010 14:59:24 PAGE 5   

 242   1              v_W1302(0x8e, 0x80);            //控制命令,WP=1,写保护
 243   1      }
 244          
 245          /********************************************************************
 246          * 名称   : v_Get1302(uchar ucCurtime[])
 247          * 功能   : 读取DS1302当前时间
 248          * 输入   : ucCurtime: 保存当前时间地址。当前时间格式为: 秒 分 时 日 月 星期 年
 249          *                                         7Byte (BCD码) 1B 1B 1B 1B 1B  1B  1B
 250          * 返回值 : 无
 251          ***********************************************************************/
 252          void v_Get1302(uchar ucCurtime[])
 253          {
 254   1              uchar i;
 255   1              uchar ucAddr = 0x81;
 256   1              for(i=0; i<7; i++)
 257   1              {
 258   2                      ucCurtime[i] = uc_R1302(ucAddr);    //格式为: 秒 分 时 日 月 星期 年
 259   2                      ucAddr += 2;
 260   2              }
 261   1      }
 262          
 263          /********************************************************************
 264          * 名称 : dectobcd(uchar dec)
 265          * 功能 : DEC码转换为BCD码
 266          * 输入 : dec码
 267          * 输出 : bcd码
 268          ***********************************************************************/
 269          uchar dectobcd(uchar dec)
 270          {
 271   1              uchar bcd;
 272   1              bcd = 0;
 273   1              while(dec >= 10)
 274   1              {              
 275   2                      dec -= 10;                         
 276   2                      bcd++;
 277   2              } 
 278   1              bcd <<= 4;
 279   1              bcd |= dec;
 280   1              return bcd;
 281   1      }
 282          
 283          /********************************************************************
 284          * 名称 : bcdtodec(uchar bcd)
 285          * 功能 : BCD码转换为DEC码
 286          * 输入 : bcd码
 287          * 输出 : dec码
 288          ***********************************************************************/
 289          uchar bcdtodec(uchar bcd)
 290          {
 291   1              uchar data1;
 292   1              data1 = bcd & 0x0f;     //取BCD低4位
 293   1              bcd = bcd & 0x70;       //剔除BCD的最高位和低4位。
 294   1              data1 += bcd >> 1;
 295   1              data1 += bcd >> 3;      //用位移代替乘法运算
 296   1              return data1;
 297   1      }
 298          
 299          /********************************************************************
 300          * 名称 : Write_DS1302Init()
 301          * 功能 : 往DS1302中写入数据。最开始显示的数据就是在这里设置的。
 302          * 输入 : 无
 303          * 输出 : 无
C51 COMPILER V7.02b   _钟DS1302LCD                                                        02/25/2010 14:59:24 PAGE 6   

 304          ***********************************************************************/
 305          void Write_DS1302Init(void)
 306          {
 307   1              v_W1302(0x8e,0);
 308   1              v_W1302(0x80,0x50);     //写入秒
 309   1              v_W1302(0x8e,0);
 310   1              v_W1302(0x82,0x59);     //写入分
 311   1              v_W1302(0x8e,0);
 312   1              v_W1302(0x84,0x07);     //写入小时
 313   1              v_W1302(0x8e,0);
 314   1              v_W1302(0x86,0x08);     //写入日
 315   1              v_W1302(0x8e,0);
 316   1              v_W1302(0x88,0x08);     //写入月
 317   1              v_W1302(0x8e,0);
 318   1              v_W1302(0x8a,0x05);     //写入星期
 319   1              v_W1302(0x8e,0);
 320   1              v_W1302(0x8c,0x08);     //写入年        
 321   1      }
 322          
 323          /********************************************************************
 324          * 名称 : Run_DS1302(void)
 325          * 功能 : 读出DS1302中的数据，并在液晶1602上进行显示
 326          * 输入 : 无
 327          * 输出 : 无
 328          ***********************************************************************/
 329          void Run_DS1302(void)
 330          {
 331   1              uchar sec, min, hour, day, month, year;
 332   1              while(1)
 333   1              {
 334   2                      v_W1302(0x8f, 0);
 335   2                      sec = bcdtodec(uc_R1302(0x81));    //读出DS1302中的秒
 336   2                      v_W1302(0x8f, 0);
 337   2                      min = bcdtodec(uc_R1302(0x83));    //读出DS1302中的分
 338   2                      v_W1302(0x8f, 0);
 339   2                      hour = bcdtodec(uc_R1302(0x85));   //读出DS1302中的小时
 340   2                      v_W1302(0x8f, 0);
 341   2                      day = bcdtodec(uc_R1302(0x87));    //读出DS1302中的日
 342   2                      v_W1302(0x8f, 0);
 343   2                      month = bcdtodec(uc_R1302(0x89));  //读出DS1302中的月
 344   2                      v_W1302(0x8f, 0);
 345   2                      year = bcdtodec(uc_R1302(0x8d));   //读出DS1302中的年
 346   2      
 347   2                      P0 = table[hour / 10 % 10];
 348   2                      P2 = 0;
 349   2                      Delay_1ms(2);
 350   2                      P0 = table[hour % 10];
 351   2                      P2 = 1;
 352   2                      Delay_1ms(2);
 353   2                      P0 = 0x80;
 354   2                      P2 = 2;
 355   2                      Delay_1ms(2);
 356   2                      P0 = table[min / 10 % 10];
 357   2                      P2 = 3;
 358   2                      Delay_1ms(2);
 359   2                      P0 = table[min % 10];
 360   2                      P2 = 4;
 361   2                      Delay_1ms(2);
 362   2                      P0 = 0x80;
 363   2                      P2 = 5;
 364   2                      Delay_1ms(2);
 365   2                      P0 = table[sec / 10 % 10];
C51 COMPILER V7.02b   _钟DS1302LCD                                                        02/25/2010 14:59:24 PAGE 7   

 366   2                      P2 = 6;
 367   2                      Delay_1ms(2);
 368   2                      P0 = table[sec % 10];
 369   2                      P2 = 7;
 370   2                      Delay_1ms(2);
 371   2              }
 372   1      } 
 373          
 374          /********************************************************************
 375          * 名称 : Main(void)
 376          * 功能 : 主函数
 377          * 输入 : 无
 378          * 输出 : 无
 379          ***********************************************************************/ 
 380          void Main(void)
 381          {
 382   1              Write_DS1302Init();
 383   1              Run_DS1302();
 384   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    685    ----
   CONSTANT SIZE    =     10    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----       7
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
